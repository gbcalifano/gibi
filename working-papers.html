<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Working papers</title>
  <meta name="description" content="A minimal research tracker for working papers (GitHub-backed)." />
  <link rel="stylesheet" href="style.css">

  <style>
    /* Working papers tracker — minimal brutalist, aligned with califano.xyz */

    .muted { opacity: 0.60; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .row > * { flex: 0 0 auto; }

    input[type="text"], input[type="password"], input[type="date"], select, textarea {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 16px;
      line-height: 18px;
      padding: 8px 10px;
      border: 1px solid #000;
      background: transparent;
      color: inherit;
      width: 100%;
      max-width: 100%;
      transition: border-color 0.12s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-width: 2px;
    }
    textarea {
      font-size: 18px;
      line-height: 24px;
      min-height: 110px;
      resize: vertical;
    }

    @media (prefers-color-scheme: dark) {
      input[type="text"], input[type="password"], input[type="date"], select, textarea {
        border-color: #fff;
      }
    }

    .panel {
      margin: 40px 0;
      border-top: 1px solid silver;
      padding-top: 20px;
    }
    @media (prefers-color-scheme: dark) {
      .panel { border-color: #fff; }
    }

    .small { font-size: 16px; line-height: 18px; }
    .tiny  { font-size: 13px; line-height: 15px; }

    /* Tag / collab pills */
    .pill {
      display: inline-block;
      border: 1px solid currentColor;
      padding: 2px 7px;
      font-size: 13px;
      line-height: 16px;
      margin-right: 5px;
      margin-top: 5px;
      white-space: nowrap;
      opacity: 0.7;
    }

    .actions-inline { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
    .actions-inline button { margin: 0; }

    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 767px) {
      .two-col { grid-template-columns: 1fr; }
    }

    /* Status badges */
    .badge {
      display: inline-block;
      font-size: 11px;
      line-height: 13px;
      padding: 3px 7px;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      white-space: nowrap;
      border: 1.5px solid transparent;
    }
    .badge-submitted { border-color: #0050cc; color: #0050cc; }
    .badge-revision  { border-color: #884400; color: #884400; }
    .badge-accepted  { border-color: #006622; color: #006622; }
    .badge-rejected  { border-color: #880000; color: #880000; }
    .badge-none      { border-color: #aaa;    color: #999; }
    @media (prefers-color-scheme: dark) {
      .badge-submitted { border-color: #6699ff; color: #6699ff; }
      .badge-revision  { border-color: #ffcc44; color: #ffcc44; }
      .badge-accepted  { border-color: #44dd77; color: #44dd77; }
      .badge-rejected  { border-color: #ff6655; color: #ff6655; }
      .badge-none      { border-color: #555;    color: #888; }
    }

    /* Papers table */
    .papers-table { margin-top: 16px; }
    .papers-table td { padding: 12px 8px 12px 0; vertical-align: top; }
    .papers-table td:first-child { padding-left: 0; width: 120px; }
    .papers-table tbody tr { border-bottom: 1px solid #eee; transition: background 0.08s; }
    .papers-table tbody tr:last-child { border-bottom: none; }
    .papers-table tbody tr:hover { background: rgba(0,0,0,0.025); }
    @media (prefers-color-scheme: dark) {
      .papers-table tbody tr { border-color: #2d2d2d; }
      .papers-table tbody tr:hover { background: rgba(255,255,255,0.04); }
    }

    .title-cell a {
      font-weight: 700;
      font-size: 17px;
      line-height: 21px;
      color: inherit;
      text-decoration: none;
    }
    .title-cell a:hover { text-decoration: underline; }

    /* Days-in-flight chip */
    .days-chip {
      display: inline-block;
      font-size: 11px;
      font-weight: 700;
      padding: 1px 5px;
      background: #f0f0f0;
      color: #666;
      margin-left: 8px;
      vertical-align: middle;
      letter-spacing: 0.03em;
    }
    @media (prefers-color-scheme: dark) {
      .days-chip { background: #2a2a2a; color: #999; }
    }

    /* Quick action buttons — compact */
    .quick-btn {
      font-size: 12px !important;
      line-height: 14px !important;
      padding: 3px 7px !important;
      margin: 0 !important;
    }

    /* Auth section collapse once logged in */
    #auth.collapsed h2 { display: none; }
    #auth.collapsed { margin: 16px 0; padding-top: 12px; }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.48);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 999;
    }
    .modal {
      background: #fff;
      color: #000;
      width: 100%;
      max-width: 860px;
      border: 2px solid #000;
      padding: 24px;
      max-height: 90vh;
      overflow-y: auto;
    }
    @media (prefers-color-scheme: dark) {
      .modal { background: #1e1e1e; color: #dedede; border-color: #fff; }
    }
    .modal-backdrop.open { display: flex; }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      border-bottom: 1px solid #ddd;
      padding-bottom: 14px;
      margin-bottom: 20px;
    }
    @media (prefers-color-scheme: dark) {
      .modal-header { border-color: #333; }
    }
    .modal-header h2 { margin: 0; font-size: 26px; line-height: 30px; }

    .sub-table td { padding: 6px 8px 6px 0; font-size: 15px; }
    .sub-table thead th { font-size: 13px; }

    /* Toast — slides up */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      border: 1.5px solid #000;
      background: #fff;
      padding: 10px 16px;
      font-size: 14px;
      line-height: 18px;
      z-index: 1000;
      transform: translateY(12px);
      opacity: 0;
      transition: transform 0.16s ease, opacity 0.16s ease;
      pointer-events: none;
    }
    @media (prefers-color-scheme: dark) {
      .toast { background: #1e1e1e; color: #dedede; border-color: #fff; }
    }
    .toast.show { transform: translateY(0); opacity: 1; }

    /* Sync line */
    #syncLine { font-size: 13px; margin-bottom: 8px; min-height: 16px; }

    /* Kbd hint */
    .kbd-hint { font-size: 12px; opacity: 0.45; }
    kbd {
      display: inline-block;
      border: 1px solid currentColor;
      border-radius: 2px;
      padding: 0 3px;
      font-family: inherit;
      font-size: 11px;
    }

    /* Empty state */
    .empty-state {
      padding: 48px 0;
      text-align: center;
      font-size: 17px;
      opacity: 0.4;
    }

    /* Stat breakdown table */
    .stat-breakdown { margin: 12px 0 0; }
    .stat-breakdown td { padding: 4px 8px 4px 0; font-size: 15px; }
  </style>
</head>

<body>
<a class="skip" href="#main">Skip to main content</a>

<div id="main" role="main">
  <header>
    <h1 class="h1">Working papers</h1>
  </header>

  <!-- AUTH -->
  <section id="auth" class="panel">
    <h2>Access</h2>

    <div class="row">
      <div style="flex: 1 1 320px; max-width: 520px;">
        <label class="small" for="token">Token</label><br>
        <input id="token" type="password" autocomplete="off" />
      </div>
      <div class="actions-inline" style="align-self: end;">
        <button id="login">Access</button>
        <button id="logout" class="hide">Log out</button>
      </div>
    </div>

    <p class="tiny muted" id="authStatus"></p>
  </section>

  <!-- CONTROLS + STATS -->
  <section id="dashboard" class="hide">
    <section class="panel">
      <h2>Overview</h2>

      <!-- stats row uses your existing .stats from style.css -->
      <div class="stats" aria-label="Key statistics">
        <div class="stat-item">
          <div id="stat-total" class="stat-number">0</div>
          <div class="stat-label">Papers</div>
        </div>
        <div class="stat-item">
          <div id="stat-active" class="stat-number">0</div>
          <div class="stat-label">Active</div>
        </div>
        <div class="stat-item">
          <div id="stat-med-active" class="stat-number">–</div>
          <div class="stat-label">Median days active</div>
        </div>
      </div>

      <div class="two-col">
        <div>
          <h3>Status breakdown</h3>
          <table class="small stat-breakdown" aria-label="Status breakdown">
            <tbody id="statusBreakdown"></tbody>
          </table>
        </div>
        <div>
          <h3>Pipeline signals</h3>
          <table class="small" aria-label="Pipeline signals">
            <tbody>
              <tr><td class="tiny muted">Median time to decision</td><td id="stat-med-decision">–</td></tr>
              <tr><td class="tiny muted">Median days since update</td><td id="stat-med-updated">–</td></tr>
              <tr><td class="tiny muted">Total submissions logged</td><td id="stat-submissions">0</td></tr>
            </tbody>
          </table>

          <h3>Tags / collaborators</h3>
          <p class="tiny muted">Top tags and most frequent collaborators (from your entries).</p>
          <div id="tagPills"></div>
          <div style="margin-top: 10px;" id="collabPills"></div>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>Tracker <span class="kbd-hint"><kbd>N</kbd> new</span></h2>

      <div class="row" style="margin-bottom: 16px;">
        <div style="flex: 1 1 260px;">
          <label class="small" for="search">Search</label><br>
          <input id="search" type="text" placeholder="Title, tags, collaborators…" />
        </div>

        <div style="flex: 0 0 240px;">
          <label class="small" for="filter">Filter</label><br>
          <select id="filter">
            <option value="All">All</option>
            <option value="Submitted">Submitted</option>
            <option value="Under Revision">Under Revision</option>
            <option value="Accepted">Accepted</option>
            <option value="Rejected">Rejected</option>
            <option value="Not Submitted">Not Submitted</option>
          </select>
        </div>

        <div style="flex: 0 0 220px;">
          <label class="small" for="sort">Sort</label><br>
          <select id="sort">
            <option value="updated">Recently updated</option>
            <option value="created">Recently created</option>
            <option value="title">Title (A–Z)</option>
            <option value="status">Status</option>
          </select>
        </div>

        <div class="actions-inline" style="align-self: end;">
          <button id="newPaper">New paper</button>
          <button id="refresh">Refresh</button>
          <button id="export">Export JSON</button>
        </div>
      </div>

      <div class="tiny muted" id="syncLine"></div>

      <table class="papers-table" aria-label="Papers list">
        <thead>
          <tr>
            <th scope="col" style="width:120px">Status</th>
            <th scope="col">Title &amp; details</th>
            <th scope="col" style="width:160px">Last venue</th>
            <th scope="col" style="width:90px">Updated</th>
            <th scope="col" style="width:200px">Quick actions</th>
          </tr>
        </thead>
        <tbody id="papersTbody">
          <tr><td colspan="5"><div class="empty-state">Authenticate to load papers.</div></td></tr>
        </tbody>
      </table>
    </section>
  </section>

  <footer role="contentinfo">
    <p><small>© Giovanbattista Califano</small></p>
  </footer>
</div>

<!-- MODAL -->
<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-label="Edit paper dialog">
  <div class="modal">
    <div class="row" style="justify-content: space-between; align-items: baseline;">
      <h2 id="modalTitle">Edit paper</h2>
      <div class="actions-inline">
        <button id="modalClose">Close</button>
      </div>
    </div>

    <div class="two-col">
      <div>
        <label class="small" for="fTitle">Title</label><br>
        <input id="fTitle" type="text" placeholder="Paper title">
      </div>
      <div>
        <label class="small" for="fLinks">Links</label><br>
        <input id="fLinks" type="text" placeholder="Comma-separated URLs (optional)">
      </div>
    </div>

    <div class="two-col" style="margin-top: 12px;">
      <div>
        <label class="small" for="fCollaborators">Collaborators</label><br>
        <input id="fCollaborators" type="text" placeholder="Name 1, Name 2">
      </div>
      <div>
        <label class="small" for="fTags">Tags</label><br>
        <input id="fTags" type="text" placeholder="AI, food, econometrics">
      </div>
    </div>

    <div style="margin-top: 12px;">
      <label class="small" for="fAbstract">Abstract / notes</label><br>
      <textarea id="fAbstract" placeholder="Short abstract or internal notes…"></textarea>
    </div>

    <div class="panel" style="margin-top: 18px;">
      <h3>Submission history</h3>
      <div class="row" style="margin: 10px 0 14px;">
        <div style="flex: 1 1 260px;">
          <label class="small" for="subJournal">Journal / venue</label><br>
          <input id="subJournal" type="text" placeholder="Journal name">
        </div>
        <div style="flex: 0 0 220px;">
          <label class="small" for="subStatus">Status</label><br>
          <select id="subStatus">
            <option>Submitted</option>
            <option>Under Revision</option>
            <option>Accepted</option>
            <option>Rejected</option>
          </select>
        </div>
        <div style="flex: 0 0 180px;">
          <label class="small" for="subDate">Date</label><br>
          <input id="subDate" type="date">
        </div>
        <div class="actions-inline" style="align-self: end;">
          <button id="addSubmission">Add</button>
        </div>
      </div>

      <table class="small sub-table" aria-label="Submission history table">
        <thead>
          <tr>
            <th scope="col">Venue</th>
            <th scope="col">Status</th>
            <th scope="col">Date</th>
            <th scope="col">Remove</th>
          </tr>
        </thead>
        <tbody id="subTbody">
          <tr><td colspan="4" class="muted tiny">No submissions yet.</td></tr>
        </tbody>
      </table>
    </div>

    <div class="row" style="justify-content: space-between; margin-top: 16px;">
      <div class="actions-inline">
        <button id="deletePaper">Delete</button>
      </div>
      <div class="actions-inline">
        <button id="savePaper">Save</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
(function () {
  "use strict";

  // --- CONFIG (same intent as your v2 page) ---
  const GITHUB_OWNER = "gbcalifano";
  const GITHUB_REPO = "private";
  const GITHUB_DATA_PATH = "papers.json";
  const TOKEN_KEY = "githubToken";

  const apiUrl = () => `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_DATA_PATH}`;

  // --- DOM ---
  const $ = (id) => document.getElementById(id);

  const auth = $("auth");
  const dashboard = $("dashboard");
  const tokenInput = $("token");
  const loginBtn = $("login");
  const logoutBtn = $("logout");
  const authStatus = $("authStatus");

  const searchEl = $("search");
  const filterEl = $("filter");
  const sortEl = $("sort");

  const newPaperBtn = $("newPaper");
  const refreshBtn = $("refresh");
  const exportBtn = $("export");
  const syncLine = $("syncLine");
  const papersTbody = $("papersTbody");

  const statTotal = $("stat-total");
  const statActive = $("stat-active");
  const statMedActive = $("stat-med-active");
  const statusBreakdown = $("statusBreakdown");
  const statMedDecision = $("stat-med-decision");
  const statMedUpdated = $("stat-med-updated");
  const statSubmissions = $("stat-submissions");
  const tagPills = $("tagPills");
  const collabPills = $("collabPills");

  const modalBackdrop = $("modalBackdrop");
  const modalTitle = $("modalTitle");
  const modalClose = $("modalClose");

  const fTitle = $("fTitle");
  const fAbstract = $("fAbstract");
  const fCollaborators = $("fCollaborators");
  const fTags = $("fTags");
  const fLinks = $("fLinks");

  const subJournal = $("subJournal");
  const subStatus = $("subStatus");
  const subDate = $("subDate");
  const addSubmission = $("addSubmission");
  const subTbody = $("subTbody");

  const deletePaperBtn = $("deletePaper");
  const savePaperBtn = $("savePaper");

  const toast = $("toast");

  // --- STATE ---
  let token = sessionStorage.getItem(TOKEN_KEY) || "";
  let fileSha = null;
  let papers = [];
  let editing = null; // paper object being edited

  // --- HELPERS ---
  const uid = () => `id_${Math.random().toString(36).slice(2)}_${Date.now()}`;
  const todayISO = () => new Date().toISOString().slice(0,10);

  const safeJSON = (s) => {
    try { return JSON.parse(s); } catch { return null; }
  };

  const fmtDate = (iso) => {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(+d)) return "";
    return d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "2-digit" });
  };

  const daysBetween = (a, b) => {
    if (!a || !b) return null;
    const d1 = new Date(a);
    const d2 = new Date(b);
    if (Number.isNaN(+d1) || Number.isNaN(+d2)) return null;
    return Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));
  };

  const median = (arr) => {
    const a = arr.filter(v => typeof v === "number" && isFinite(v)).sort((x,y)=>x-y);
    if (!a.length) return null;
    const mid = Math.floor(a.length / 2);
    return a.length % 2 ? a[mid] : (a[mid-1] + a[mid]) / 2;
  };

  const lastStatus = (p) => {
    const subs = Array.isArray(p.submissions) ? p.submissions : [];
    if (!subs.length) return "Not Submitted";
    return subs[subs.length - 1].status || "Not Submitted";
  };

  const firstSubmissionDate = (p) => {
    const subs = Array.isArray(p.submissions) ? p.submissions : [];
    if (!subs.length) return null;
    // earliest date among submissions with date
    const dates = subs.map(s => s.date).filter(Boolean).sort();
    return dates[0] || null;
  };

  const lastSubmission = (p) => {
    const subs = Array.isArray(p.submissions) ? p.submissions : [];
    return subs.length ? subs[subs.length - 1] : null;
  };

  const lastTouched = (p) => p.updatedAt || p.createdAt || null;

  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2400);
  }

  function setSync(msg, state) {
    syncLine.textContent = msg || "";
    syncLine.className = state || "";
  }

  // --- GITHUB IO ---
  function headers() {
    return {
      "Authorization": `token ${token}`,
      "Accept": "application/vnd.github.v3+json"
    };
  }

  async function loadData() {
    setSync("Loading…", "busy");
    try {
      const res = await fetch(apiUrl(), { headers: headers() });
      if (res.status === 404) {
        fileSha = null;
        papers = [];
        setSync("No papers.json found — will be created on first save.", "");
        renderAll();
        return;
      }
      if (!res.ok) throw new Error("Fetch failed");
      const data = await res.json();
      fileSha = data.sha;

      const decoded = atob(data.content || "");
      const parsed = safeJSON(decoded);
      papers = Array.isArray(parsed) ? parsed : [];

      // Normalize
      papers = papers.map(p => ({
        id: p.id || uid(),
        title: p.title || "",
        abstract: p.abstract || "",
        collaborators: Array.isArray(p.collaborators) ? p.collaborators : [],
        tags: Array.isArray(p.tags) ? p.tags : [],
        links: Array.isArray(p.links) ? p.links : [],
        submissions: Array.isArray(p.submissions) ? p.submissions : [],
        createdAt: p.createdAt || null,
        updatedAt: p.updatedAt || null
      }));

      setSync("Loaded.", "ok");
      renderAll();
    } catch (e) {
      setSync("Error loading. Check token / permissions / connectivity.", "err");
    }
  }

  async function saveData(nextPapers) {
    setSync("Saving…", "busy");
    papers = nextPapers;

    try {
      const payload = btoa(JSON.stringify(papers, null, 2));
      const body = {
        message: "Update papers",
        content: payload,
        sha: fileSha || undefined
      };

      const res = await fetch(apiUrl(), {
        method: "PUT",
        headers: { ...headers(), "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (!res.ok) throw new Error("Save failed");
      const data = await res.json();
      fileSha = data.content && data.content.sha ? data.content.sha : fileSha;

      setSync("Saved.", "ok");
      showToast("Saved");
      renderAll();
    } catch (e) {
      setSync("Sync failed. Changes not persisted.", "err");
      showToast("Sync failed");
    }
  }

  // --- AUTH FLOW ---
  function updateAuthUI() {
    const ok = !!token;
    dashboard.classList.toggle("hide", !ok);
    logoutBtn.classList.toggle("hide", !ok);
    loginBtn.disabled = ok;
    tokenInput.disabled = ok;
    authStatus.textContent = ok ? "Token active for this session." : "";
    auth.classList.toggle("collapsed", ok);
  }

  loginBtn.addEventListener("click", async () => {
    const t = tokenInput.value.trim();
    if (!t) return;
    token = t;
    sessionStorage.setItem(TOKEN_KEY, token);
    tokenInput.value = "";
    updateAuthUI();
    await loadData();
  });

  logoutBtn.addEventListener("click", () => {
    token = "";
    sessionStorage.removeItem(TOKEN_KEY);
    fileSha = null;
    papers = [];
    updateAuthUI();
    papersTbody.innerHTML = `<tr><td colspan="5"><div class="empty-state">Authenticate to load papers.</div></td></tr>`;
    setSync("");
  });

  // --- DERIVED VIEW ---
  function computeStats(all) {
    const counts = {
      "All": all.length,
      "Submitted": 0,
      "Under Revision": 0,
      "Accepted": 0,
      "Rejected": 0,
      "Not Submitted": 0
    };

    let totalSubmissions = 0;

    const activeDays = [];
    const decisionDays = [];
    const daysSinceUpdate = [];

    const tagCounts = new Map();
    const collabCounts = new Map();

    const today = todayISO();

    all.forEach(p => {
      const st = lastStatus(p);
      counts[st] = (counts[st] || 0) + 1;

      const subs = Array.isArray(p.submissions) ? p.submissions : [];
      totalSubmissions += subs.length;

      const fst = firstSubmissionDate(p);
      if (fst && (st === "Submitted" || st === "Under Revision")) {
        const d = daysBetween(fst, today);
        if (typeof d === "number") activeDays.push(d);
      }

      if (fst && (st === "Accepted" || st === "Rejected")) {
        // decision date = date of last submission entry (often the decision update)
        const lst = lastSubmission(p);
        const decisionDate = (lst && lst.date) ? lst.date : null;
        const d = daysBetween(fst, decisionDate || today);
        if (typeof d === "number") decisionDays.push(d);
      }

      const touched = lastTouched(p);
      if (touched) {
        const d = daysBetween(touched.slice(0,10), today);
        if (typeof d === "number") daysSinceUpdate.push(d);
      }

      (p.tags || []).forEach(t => {
        const k = String(t).trim();
        if (!k) return;
        tagCounts.set(k, (tagCounts.get(k) || 0) + 1);
      });

      (p.collaborators || []).forEach(c => {
        const k = String(c).trim();
        if (!k) return;
        collabCounts.set(k, (collabCounts.get(k) || 0) + 1);
      });
    });

    const active = (counts["Submitted"] || 0) + (counts["Under Revision"] || 0);

    return {
      counts,
      active,
      totalSubmissions,
      medActiveDays: median(activeDays),
      medDecisionDays: median(decisionDays),
      medDaysSinceUpdate: median(daysSinceUpdate),
      topTags: [...tagCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0, 10),
      topCollabs: [...collabCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0, 10)
    };
  }

  function statusLabel(st) {
    // keep minimal
    return st;
  }

  function fmtDays(d) {
    if (d === null || d === undefined) return "–";
    if (!isFinite(d)) return "–";
    const rounded = Math.round(d);
    return String(rounded);
  }

  function renderStats() {
    const s = computeStats(papers);

    statTotal.textContent = String(s.counts["All"] || 0);
    statActive.textContent = String(s.active || 0);
    statMedActive.textContent = s.medActiveDays == null ? "–" : fmtDays(s.medActiveDays);

    statMedDecision.textContent = s.medDecisionDays == null ? "–" : (fmtDays(s.medDecisionDays) + " days");
    statMedUpdated.textContent = s.medDaysSinceUpdate == null ? "–" : (fmtDays(s.medDaysSinceUpdate) + " days");
    statSubmissions.textContent = String(s.totalSubmissions || 0);

    // Breakdown table
    const order = ["Submitted","Under Revision","Accepted","Rejected","Not Submitted"];
    statusBreakdown.innerHTML = order.map(k => {
      const v = s.counts[k] || 0;
      return `<tr><td class="tiny muted">${statusLabel(k)}</td><td>${v}</td></tr>`;
    }).join("");

    // Pills
    const mkPills = (entries) => entries.map(([k,v]) => `<span class="pill">${escapeHTML(k)} <span class="muted">(${v})</span></span>`).join("");
    tagPills.innerHTML = s.topTags.length ? mkPills(s.topTags) : `<span class="tiny muted">No tags yet.</span>`;
    collabPills.innerHTML = s.topCollabs.length ? mkPills(s.topCollabs) : `<span class="tiny muted">No collaborators yet.</span>`;
  }

  function escapeHTML(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function statusBadge(st) {
    const cls = {
      "Submitted":     "badge-submitted",
      "Under Revision":"badge-revision",
      "Accepted":      "badge-accepted",
      "Rejected":      "badge-rejected",
      "Not Submitted": "badge-none"
    }[st] || "badge-none";
    const label = {
      "Submitted":     "Submitted",
      "Under Revision":"Revision",
      "Accepted":      "Accepted",
      "Rejected":      "Rejected",
      "Not Submitted": "Draft"
    }[st] || st;
    return `<span class="badge ${cls}">${escapeHTML(label)}</span>`;
  }

  function renderDaysChip(p, st) {
    if (st !== "Submitted" && st !== "Under Revision") return "";
    const fst = firstSubmissionDate(p);
    if (!fst) return "";
    const today = todayISO();
    const d = daysBetween(fst, today);
    if (d === null) return "";
    return `<br><span class="days-chip">${d}d</span>`;
  }

  function matchQuery(p, q) {
    if (!q) return true;
    q = q.toLowerCase();
    const inTitle = (p.title || "").toLowerCase().includes(q);
    const inTags = (p.tags || []).some(t => String(t).toLowerCase().includes(q));
    const inCollabs = (p.collaborators || []).some(c => String(c).toLowerCase().includes(q));
    return inTitle || inTags || inCollabs;
  }

  function sortKeyStatus(st) {
    const order = { "Under Revision": 1, "Submitted": 2, "Not Submitted": 3, "Accepted": 4, "Rejected": 5 };
    return order[st] || 99;
  }

  function renderTable() {
    const q = searchEl.value.trim();
    const f = filterEl.value;
    const s = sortEl.value;

    let list = papers.slice();

    if (f !== "All") {
      list = list.filter(p => lastStatus(p) === f);
    }
    if (q) {
      list = list.filter(p => matchQuery(p, q));
    }

    list.sort((a,b) => {
      if (s === "title") return (a.title || "").localeCompare(b.title || "");
      if (s === "created") return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
      if (s === "status") return sortKeyStatus(lastStatus(a)) - sortKeyStatus(lastStatus(b));
      // updated default
      return new Date(b.updatedAt || b.createdAt || 0) - new Date(a.updatedAt || a.createdAt || 0);
    });

    if (!list.length) {
      papersTbody.innerHTML = `<tr><td colspan="5"><div class="empty-state">No papers found.</div></td></tr>`;
      return;
    }

    papersTbody.innerHTML = list.map(p => {
      const st = lastStatus(p);
      const last = lastSubmission(p);
      const venue = last ? (last.journal || "") : "";
      const lastLine = last
        ? `<span style="font-size:14px">${escapeHTML(venue)}</span><br><span class="tiny muted">${escapeHTML(fmtDate(last.date))}</span>`
        : `<span class="tiny muted">—</span>`;
      const upd = lastTouched(p) ? fmtDate(lastTouched(p).slice(0,10)) : "—";
      const daysChip = renderDaysChip(p, st);

      return `
        <tr>
          <td>${statusBadge(st)}${daysChip}</td>
          <td class="title-cell">
            <a href="#" data-edit="${escapeHTML(p.id)}">${escapeHTML(p.title || "(untitled)")}</a>
            ${renderMiniMeta(p)}
          </td>
          <td>${lastLine}</td>
          <td><span class="tiny muted">${escapeHTML(upd)}</span></td>
          <td>
            <div class="actions-inline" style="flex-wrap:wrap;gap:4px;">
              <button class="quick-btn" data-quick="Submitted" data-id="${escapeHTML(p.id)}">Submit</button>
              <button class="quick-btn" data-quick="Under Revision" data-id="${escapeHTML(p.id)}">Revise</button>
              <button class="quick-btn" data-quick="Accepted" data-id="${escapeHTML(p.id)}">Accept</button>
              <button class="quick-btn" data-quick="Rejected" data-id="${escapeHTML(p.id)}">Reject</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");
  }

  function renderMiniMeta(p) {
    const collabs = (p.collaborators || []).filter(Boolean);
    const tags = (p.tags || []).filter(Boolean);

    let html = "";
    if (collabs.length) html += `<div class="tiny muted">${escapeHTML(collabs.join(", "))}</div>`;
    if (tags.length) html += `<div class="tiny muted">${escapeHTML(tags.join(" · "))}</div>`;
    return html ? `<div style="margin-top: 6px;">${html}</div>` : "";
  }

  function renderAll() {
    renderStats();
    renderTable();
  }

  // --- MODAL CRUD ---
  function openModal(paper) {
    editing = paper;

    modalTitle.textContent = paper && paper.id ? "Edit paper" : "New paper";
    fTitle.value = paper.title || "";
    fAbstract.value = paper.abstract || "";
    fCollaborators.value = (paper.collaborators || []).join(", ");
    fTags.value = (paper.tags || []).join(", ");
    fLinks.value = (paper.links || []).map(x => (x && x.url) ? x.url : String(x || "")).filter(Boolean).join(", ");

    subJournal.value = "";
    subStatus.value = "Submitted";
    subDate.value = todayISO();

    renderSubTable();

    modalBackdrop.classList.add("open");
    fTitle.focus();
  }

  function closeModal() {
    modalBackdrop.classList.remove("open");
    editing = null;
  }

  function renderSubTable() {
    const subs = (editing && Array.isArray(editing.submissions)) ? editing.submissions : [];
    if (!subs.length) {
      subTbody.innerHTML = `<tr><td colspan="4" class="muted tiny">No submissions yet.</td></tr>`;
      return;
    }
    subTbody.innerHTML = subs.map((s, i) => `
      <tr>
        <td>${escapeHTML(s.journal || "")}</td>
        <td>${escapeHTML(s.status || "")}</td>
        <td>${escapeHTML(fmtDate(s.date) || "")}</td>
        <td><button data-rmsub="${i}">Remove</button></td>
      </tr>
    `).join("");
  }

  function normalizeCSV(str) {
    return str.split(",").map(x => x.trim()).filter(Boolean);
  }

  function normalizeLinks(str) {
    const urls = normalizeCSV(str);
    return urls.map(u => ({ url: u }));
  }

  function upsertPaperFromModal() {
    const now = new Date().toISOString();

    const base = editing && editing.id ? editing : { id: uid(), createdAt: now };
    const next = {
      ...base,
      title: fTitle.value.trim(),
      abstract: fAbstract.value.trim(),
      collaborators: normalizeCSV(fCollaborators.value),
      tags: normalizeCSV(fTags.value),
      links: normalizeLinks(fLinks.value),
      submissions: Array.isArray(base.submissions) ? base.submissions : [],
      updatedAt: now
    };

    // Upsert into list
    const exists = papers.some(p => p.id === next.id);
    const nextPapers = exists
      ? papers.map(p => p.id === next.id ? next : p)
      : [next, ...papers];

    return { next, nextPapers };
  }

  // --- EVENTS ---
  modalClose.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e) => {
    if (e.target === modalBackdrop) closeModal();
  });

  addSubmission.addEventListener("click", () => {
    if (!editing) return;
    const j = subJournal.value.trim();
    if (!j) { showToast("Add a journal/venue"); return; }
    const st = subStatus.value;
    const dt = subDate.value || todayISO();

    editing.submissions = Array.isArray(editing.submissions) ? editing.submissions : [];
    editing.submissions.push({ journal: j, status: st, date: dt });

    subJournal.value = "";
    renderSubTable();
  });

  subTbody.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn || !editing) return;
    const idx = btn.getAttribute("data-rmsub");
    if (idx === null) return;
    const i = parseInt(idx, 10);
    if (!isFinite(i)) return;
    editing.submissions = (editing.submissions || []).filter((_, k) => k !== i);
    renderSubTable();
  });

  savePaperBtn.addEventListener("click", async () => {
    if (!fTitle.value.trim()) { showToast("Title required"); return; }
    const { next, nextPapers } = upsertPaperFromModal();
    closeModal();
    await saveData(nextPapers);
  });

  deletePaperBtn.addEventListener("click", async () => {
    if (!editing || !editing.id) { closeModal(); return; }
    const ok = confirm("Delete this paper? This cannot be undone.");
    if (!ok) return;
    const id = editing.id;
    closeModal();
    await saveData(papers.filter(p => p.id !== id));
  });

  newPaperBtn.addEventListener("click", () => openModal({
    id: null,
    title: "",
    abstract: "",
    collaborators: [],
    tags: [],
    links: [],
    submissions: [],
    createdAt: null,
    updatedAt: null
  }));

  refreshBtn.addEventListener("click", loadData);

  exportBtn.addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(papers, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "papers-export.json";
    a.click();
    URL.revokeObjectURL(url);
    showToast("Exported");
  });

  searchEl.addEventListener("input", renderTable);
  filterEl.addEventListener("change", renderTable);
  sortEl.addEventListener("change", renderTable);

  papersTbody.addEventListener("click", async (e) => {
    const edit = e.target.closest("a[data-edit]");
    if (edit) {
      e.preventDefault();
      const id = edit.getAttribute("data-edit");
      const p = papers.find(x => x.id === id);
      if (p) openModal(JSON.parse(JSON.stringify(p))); // clone
      return;
    }

    const qb = e.target.closest("button[data-quick]");
    if (qb) {
      const id = qb.getAttribute("data-id");
      const st = qb.getAttribute("data-quick");
      const p = papers.find(x => x.id === id);
      if (!p) return;

      const now = new Date().toISOString();
      const last = lastSubmission(p);
      const journal = last && last.journal ? last.journal : "Unknown Journal";

      const updated = {
        ...p,
        submissions: [...(p.submissions || []), { journal, status: st, date: todayISO() }],
        updatedAt: now
      };

      await saveData(papers.map(x => x.id === id ? updated : x));
      return;
    }
  });

  // --- INIT ---
  function updateAuthCollapse() {
    const ok = !!token;
    auth.classList.toggle("collapsed", ok);
  }

  // Keyboard shortcuts
  document.addEventListener("keydown", (e) => {
    // N = new paper (when dashboard is visible, modal not open, not in input)
    if (e.key === "n" || e.key === "N") {
      const tag = document.activeElement.tagName.toLowerCase();
      if (tag === "input" || tag === "textarea" || tag === "select") return;
      if (modalBackdrop.classList.contains("open")) return;
      if (dashboard.classList.contains("hide")) return;
      e.preventDefault();
      newPaperBtn.click();
    }
    // Escape = close modal
    if (e.key === "Escape" && modalBackdrop.classList.contains("open")) {
      closeModal();
    }
  });

  function init() {
    updateAuthUI();
    updateAuthCollapse();
    if (token) {
      loadData();
    } else {
      tokenInput.focus();
    }
  }

  init();

})();
</script>
</body>
</html>