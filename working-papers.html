<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Research Tracker v2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" defer></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            surface: { 50: '#f9fafb', 100: '#f3f4f6', 200: '#e5e7eb', 800: '#1f2937', 900: '#111827' },
            brand: { light: '#2563eb', DEFAULT: '#3b82f6', dark: '#1d4ed8' } // Professional Blue
          }
        }
      }
    };
  </script>
  <style>
    body { background-color: #f9fafb; color: #111827; }
    html.dark body { background-color: #0f172a; color: #f3f4f6; }
    .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    html.dark .custom-scroll::-webkit-scrollbar-thumb { background: #334155; }
    .card-hover { transition: all 0.2s ease-in-out; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
  const { useState, useEffect, useMemo, useCallback, useRef } = React;

  // --- CONFIGURATION ---
  const GITHUB_OWNER = 'gbcalifano';
  const GITHUB_REPO = 'private';
  const GITHUB_DATA_PATH = 'papers.json';
  const GITHUB_TOKEN_KEY = 'githubToken';

  // --- ICONS (SVG) ---
  const Icons = {
    Plus: () => <svg fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>,
    Trash: () => <svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>,
    Edit: () => <svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>,
    Search: () => <svg fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>,
    Link: () => <svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-3 h-3"><path strokeLinecap="round" strokeLinejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg>,
    Moon: () => <svg fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>,
    Sun: () => <svg fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>,
    Check: () => <svg fill="none" viewBox="0 0 24 24" strokeWidth={3} stroke="currentColor" className="w-3 h-3"><path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>,
    History: () => <svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
    Refresh: () => <svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>,
    Download: () => <svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>,
    Filter: () => <svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" /></svg>,
  };

  // --- HELPERS ---
  const uid = () => `id_${Math.random().toString(36).slice(2)}_${Date.now()}`;
  const todayISO = () => new Date().toISOString().split('T')[0];
  const fmtDate = (d) => d ? new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' }) : '';
  const daysBetween = (d1, d2) => Math.ceil(Math.abs(new Date(d2) - new Date(d1)) / (1000 * 60 * 60 * 24));

  const StatusColors = {
    'Accepted': 'bg-emerald-100 text-emerald-800 border-emerald-200 dark:bg-emerald-900/40 dark:text-emerald-300 dark:border-emerald-800',
    'Under Revision': 'bg-amber-100 text-amber-800 border-amber-200 dark:bg-amber-900/40 dark:text-amber-300 dark:border-amber-800',
    'Submitted': 'bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-900/40 dark:text-blue-300 dark:border-blue-800',
    'Rejected': 'bg-rose-100 text-rose-800 border-rose-200 dark:bg-rose-900/40 dark:text-rose-300 dark:border-rose-800',
    'Not Submitted': 'bg-slate-100 text-slate-600 border-slate-200 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700'
  };

  // --- COMPONENTS ---

  const Toast = ({ message, type, onClose }) => {
    useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
    const bg = type === 'error' ? 'bg-red-500' : 'bg-slate-800 dark:bg-white';
    const text = type === 'error' ? 'text-white' : 'text-white dark:text-slate-900';
    return (
      <div className={`fixed bottom-6 right-6 z-50 px-4 py-3 rounded shadow-lg flex items-center gap-3 animate-bounce-in ${bg} ${text}`}>
        <span className="font-medium text-sm">{message}</span>
      </div>
    );
  };

  const Modal = ({ title, onClose, children, maxWidth = "max-w-2xl" }) => (
    <div className="fixed inset-0 z-40 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" onClick={onClose}>
      <div className={`bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full ${maxWidth} max-h-[90vh] overflow-hidden flex flex-col`} onClick={e => e.stopPropagation()}>
        <div className="flex items-center justify-between px-6 py-4 border-b border-slate-100 dark:border-slate-800">
          <h2 className="text-lg font-bold text-slate-900 dark:text-white">{title}</h2>
          <button onClick={onClose} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><Icons.Plus className="rotate-45" /></button>
        </div>
        <div className="overflow-y-auto p-6 custom-scroll">{children}</div>
      </div>
    </div>
  );

  const StatusBadge = ({ status }) => (
    <span className={`text-[11px] font-semibold px-2.5 py-0.5 rounded-full border ${StatusColors[status] || StatusColors['Not Submitted']}`}>
      {status}
    </span>
  );

  // --- MAIN APP ---

  function App() {
    const [token, setToken] = useState(sessionStorage.getItem(GITHUB_TOKEN_KEY));
    
    if (!token) return <AuthScreen onLogin={t => { sessionStorage.setItem(GITHUB_TOKEN_KEY, t); setToken(t); }} />;
    return <Dashboard token={token} onLogout={() => { sessionStorage.removeItem(GITHUB_TOKEN_KEY); setToken(null); }} />;
  }

  function AuthScreen({ onLogin }) {
    const [val, setVal] = useState('');
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 dark:bg-slate-950 p-4">
        <div className="w-full max-w-md bg-white dark:bg-slate-900 p-8 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-800 text-center">
          <div className="mb-6 flex justify-center"><div className="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-xl flex items-center justify-center text-blue-600 dark:text-blue-300"><i className="fa-solid fa-lock text-xl"></i></div></div>
          <h1 className="text-2xl font-bold mb-2 dark:text-white">Research Tracker</h1>
          <p className="text-slate-500 dark:text-slate-400 text-sm mb-6">Enter your GitHub Personal Access Token</p>
          <form onSubmit={e => { e.preventDefault(); if(val.trim()) onLogin(val); }}>
            <input type="password" value={val} onChange={e => setVal(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500 focus:outline-none mb-4" placeholder="github_pat_..." autoFocus />
            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition">Access Dashboard</button>
          </form>
        </div>
      </div>
    );
  }

  function Dashboard({ token, onLogout }) {
    // State
    const [papers, setPapers] = useState([]);
    const [fileSha, setFileSha] = useState(null);
    const [loading, setLoading] = useState(true);
    const [syncing, setSyncing] = useState(false);
    const [toast, setToast] = useState(null);
    
    // UI State
    const [sidebarOpen, setSidebarOpen] = useState(true); // Default open on desktop
    const [filterStatus, setFilterStatus] = useState('All');
    const [search, setSearch] = useState('');
    const [sortBy, setSortBy] = useState('updated'); // updated, title, status
    const [editingPaper, setEditingPaper] = useState(null); // Paper obj or null
    const [deleteConfirm, setDeleteConfirm] = useState(null); // ID

    // Data Fetching
    const api = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_DATA_PATH}`;
    const headers = useMemo(() => ({ 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }), [token]);

    const loadData = useCallback(async () => {
      setLoading(true);
      try {
        const res = await fetch(api, { headers });
        if (res.status === 404) { setPapers([]); return; }
        if (!res.ok) throw new Error('Failed to fetch');
        const data = await res.json();
        setFileSha(data.sha);
        const content = JSON.parse(atob(data.content));
        // Normalize data
        setPapers(content.map(p => ({ ...p, submissions: p.submissions || [], links: p.links || [] })));
      } catch (err) {
        setToast({ msg: 'Error loading data. Check token/internet.', type: 'error' });
      } finally { setLoading(false); }
    }, [api, headers]);

    useEffect(() => { loadData(); }, [loadData]);

    const saveData = async (newPapers) => {
      setSyncing(true);
      setPapers(newPapers); // Optimistic update
      try {
        const content = btoa(JSON.stringify(newPapers, null, 2));
        const body = { message: 'Update papers [v2]', content, sha: fileSha };
        const res = await fetch(api, { method: 'PUT', headers, body: JSON.stringify(body) });
        if (!res.ok) throw new Error('Save failed');
        const data = await res.json();
        setFileSha(data.content.sha);
        setToast({ msg: 'Saved successfully', type: 'success' });
      } catch (err) {
        setToast({ msg: 'Sync failed! Changes local only.', type: 'error' });
      } finally { setSyncing(false); }
    };

    // Actions
    const handleSavePaper = (paper) => {
      const now = new Date().toISOString();
      let updated;
      if (papers.find(p => p.id === paper.id)) {
        updated = papers.map(p => p.id === paper.id ? { ...paper, updatedAt: now } : p);
      } else {
        updated = [{ ...paper, id: uid(), createdAt: now, updatedAt: now }, ...papers];
      }
      saveData(updated);
      setEditingPaper(null);
    };

    const handleDelete = (id) => {
      saveData(papers.filter(p => p.id !== id));
      setDeleteConfirm(null);
    };

    // Derived State
    const processedPapers = useMemo(() => {
      let res = papers;
      if (filterStatus !== 'All') res = res.filter(p => {
        const last = p.submissions.length ? p.submissions[p.submissions.length-1].status : 'Not Submitted';
        return last === filterStatus;
      });
      if (search) {
        const q = search.toLowerCase();
        res = res.filter(p => p.title.toLowerCase().includes(q) || (p.tags||[]).some(t=>t.toLowerCase().includes(q)) || (p.collaborators||[]).some(c=>c.toLowerCase().includes(q)));
      }
      res.sort((a, b) => {
        if (sortBy === 'title') return a.title.localeCompare(b.title);
        const dateA = new Date(a.updatedAt || a.createdAt);
        const dateB = new Date(b.updatedAt || b.createdAt);
        return dateB - dateA;
      });
      return res;
    }, [papers, filterStatus, search, sortBy]);

    const stats = useMemo(() => {
      const counts = { total: papers.length, accepted: 0, underReview: 0 };
      papers.forEach(p => {
        const last = p.submissions.length ? p.submissions[p.submissions.length-1].status : 'Not Submitted';
        if (last === 'Accepted') counts.accepted++;
        if (['Submitted', 'Under Revision'].includes(last)) counts.underReview++;
      });
      return counts;
    }, [papers]);

    // Theme
    const [dark, setDark] = useState(localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches));
    useEffect(() => {
      if (dark) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
      localStorage.theme = dark ? 'dark' : 'light';
    }, [dark]);

    if (loading) return <div className="min-h-screen flex items-center justify-center text-slate-400"><i className="fa-solid fa-circle-notch fa-spin text-3xl"></i></div>;

    return (
      <div className="flex min-h-screen">
        {/* Sidebar */}
        <aside className={`fixed inset-y-0 left-0 z-30 w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 transform transition-transform duration-300 lg:translate-x-0 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
          <div className="h-full flex flex-col p-6">
            <h1 className="text-xl font-bold tracking-tight mb-8 flex items-center gap-2 dark:text-white">
              <span className="w-8 h-8 rounded-lg bg-blue-600 text-white flex items-center justify-center text-sm"><i className="fa-solid fa-paper-plane"></i></span>
              Tracker
            </h1>

            {/* Global Stats */}
            <div className="grid grid-cols-2 gap-3 mb-8">
              <div className="p-3 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-900">
                <div className="text-2xl font-bold text-blue-600 dark:text-blue-400">{stats.underReview}</div>
                <div className="text-[10px] uppercase font-semibold text-slate-500 dark:text-slate-400">Reviewing</div>
              </div>
              <div className="p-3 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-900">
                <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">{stats.accepted}</div>
                <div className="text-[10px] uppercase font-semibold text-slate-500 dark:text-slate-400">Accepted</div>
              </div>
            </div>

            {/* Navigation */}
            <nav className="space-y-1 flex-1">
              <div className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Filters</div>
              {['All', 'Submitted', 'Under Revision', 'Accepted', 'Rejected', 'Not Submitted'].map(s => (
                <button key={s} onClick={() => setFilterStatus(s)} className={`w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition ${filterStatus === s ? 'bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800/50'}`}>
                  {s}
                </button>
              ))}
            </nav>

            <div className="pt-4 border-t border-slate-100 dark:border-slate-800 flex items-center justify-between">
              <button onClick={() => setDark(!dark)} className="p-2 text-slate-400 hover:text-slate-600 dark:hover:text-white transition">
                {dark ? <Icons.Sun/> : <Icons.Moon/>}
              </button>
              <button onClick={onLogout} className="text-xs font-medium text-slate-400 hover:text-red-500">Log Out</button>
            </div>
          </div>
        </aside>

        {/* Main Content */}
        <main className={`flex-1 transition-all duration-300 lg:ml-64 p-4 lg:p-8`}>
          {/* Header */}
          <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
            <div className="relative flex-1 max-w-lg">
              <Icons.Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
              <input type="text" placeholder="Search papers..." value={search} onChange={e => setSearch(e.target.value)} 
                className="w-full pl-10 pr-4 py-2.5 rounded-xl bg-white dark:bg-slate-800 border-none shadow-sm text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500" />
            </div>
            <div className="flex items-center gap-3">
              <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="bg-white dark:bg-slate-800 border-none shadow-sm rounded-lg py-2.5 px-3 text-sm text-slate-700 dark:text-slate-300 focus:ring-2 focus:ring-blue-500 cursor-pointer">
                <option value="updated">Recently Updated</option>
                <option value="title">Title (A-Z)</option>
              </select>
              <button onClick={() => setEditingPaper({ title: '', submissions: [], links: [], collaborators: [], tags: [] })} 
                className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg text-sm font-medium shadow-sm flex items-center gap-2 transition">
                <Icons.Plus /> New Paper
              </button>
            </div>
          </div>

          {/* Paper Grid */}
          <div className="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
            {processedPapers.map(paper => (
              <PaperCard 
                key={paper.id} 
                paper={paper} 
                onEdit={() => setEditingPaper(paper)} 
                onDelete={() => setDeleteConfirm(paper.id)}
                onUpdateStatus={(newSub) => {
                   const updatedSubs = [...paper.submissions, newSub];
                   handleSavePaper({ ...paper, submissions: updatedSubs });
                }}
              />
            ))}
          </div>

          {processedPapers.length === 0 && (
            <div className="text-center py-20">
              <div className="inline-block p-4 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-400 mb-4"><Icons.Filter /></div>
              <h3 className="text-lg font-medium text-slate-900 dark:text-white">No papers found</h3>
              <p className="text-slate-500 dark:text-slate-400">Try adjusting your search or filters.</p>
            </div>
          )}
        </main>

        {/* Modals & Overlays */}
        {editingPaper && (
          <EditorModal 
            paper={editingPaper} 
            onClose={() => setEditingPaper(null)} 
            onSave={handleSavePaper} 
          />
        )}

        {deleteConfirm && (
          <Modal title="Delete Paper" onClose={() => setDeleteConfirm(null)} maxWidth="max-w-sm">
            <p className="text-slate-600 dark:text-slate-300 mb-6">Are you sure you want to delete this paper? This cannot be undone.</p>
            <div className="flex justify-end gap-3">
              <button onClick={() => setDeleteConfirm(null)} className="px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg">Cancel</button>
              <button onClick={() => handleDelete(deleteConfirm)} className="px-4 py-2 text-sm font-medium bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
          </Modal>
        )}

        {/* Toast */}
        {toast && <Toast message={toast.msg} type={toast.type} onClose={() => setToast(null)} />}
        
        {/* Sync Indicator */}
        <div className={`fixed bottom-4 left-4 lg:left-72 text-xs font-medium text-slate-400 flex items-center gap-2 transition-opacity ${syncing ? 'opacity-100' : 'opacity-0'}`}>
          <i className="fa-solid fa-rotate fa-spin"></i> Saving...
        </div>
      </div>
    );
  }

  // --- SUB-COMPONENTS ---

  function PaperCard({ paper, onEdit, onDelete, onUpdateStatus }) {
    const lastSub = paper.submissions.length ? paper.submissions[paper.submissions.length-1] : null;
    const status = lastSub ? lastSub.status : 'Not Submitted';
    const journal = lastSub ? lastSub.journal : '';

    // Quick Update State
    const [showQuick, setShowQuick] = useState(false);
    const [quickJournal, setQuickJournal] = useState('');
    
    const handleQuickSubmit = (newStatus) => {
      onUpdateStatus({ 
        journal: quickJournal || (lastSub?.journal) || 'Unknown Journal', 
        status: newStatus, 
        date: todayISO() 
      });
      setShowQuick(false); setQuickJournal('');
    };

    return (
      <div className="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-5 card-hover flex flex-col h-full relative group">
        
        {/* Header: Status & Actions */}
        <div className="flex justify-between items-start mb-3">
          <StatusBadge status={status} />
          <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
            <button onClick={onEdit} className="p-1.5 text-slate-400 hover:text-blue-600 rounded bg-slate-50 dark:bg-slate-800"><Icons.Edit/></button>
            <button onClick={onDelete} className="p-1.5 text-slate-400 hover:text-red-600 rounded bg-slate-50 dark:bg-slate-800"><Icons.Trash/></button>
          </div>
        </div>

        {/* Content */}
        <div className="flex-1">
          <h3 className="font-bold text-slate-900 dark:text-white leading-tight mb-2">{paper.title}</h3>
          
          <div className="text-sm text-slate-500 dark:text-slate-400 mb-3 line-clamp-2">
             {paper.collaborators && paper.collaborators.length > 0 && <span className="mr-2 text-slate-800 dark:text-slate-200"><i className="fa-solid fa-user-group text-xs mr-1"></i> {paper.collaborators.join(', ')}</span>}
             {paper.abstract}
          </div>

          {/* Timeline Node Visualization */}
          {lastSub && (
             <div className="flex items-center gap-3 mt-4 text-xs bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg">
                <div className={`w-2 h-2 rounded-full ${status === 'Accepted' ? 'bg-emerald-500' : status === 'Rejected' ? 'bg-red-500' : 'bg-blue-500'}`}></div>
                <div className="flex-1">
                  <div className="font-medium text-slate-700 dark:text-slate-200">{journal}</div>
                  <div className="text-slate-400">{fmtDate(lastSub.date)}</div>
                </div>
                {status === 'Accepted' && paper.submissions.length > 1 && (
                   <div className="text-emerald-600 font-semibold">{daysBetween(paper.submissions[0].date, lastSub.date)} days</div>
                )}
             </div>
          )}
        </div>

        {/* Footer: Quick Actions */}
        <div className="mt-4 pt-3 border-t border-slate-100 dark:border-slate-800">
           {!showQuick ? (
              <button onClick={() => setShowQuick(true)} className="w-full text-center text-xs font-semibold text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 py-2 rounded-lg transition">
                Update Status
              </button>
           ) : (
              <div className="bg-slate-50 dark:bg-slate-800 p-2 rounded-lg animate-fade-in">
                 <input 
                    type="text" 
                    placeholder={lastSub?.journal || "Journal Name"} 
                    value={quickJournal} 
                    onChange={e => setQuickJournal(e.target.value)}
                    className="w-full text-xs p-1.5 mb-2 rounded border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700"
                    autoFocus
                 />
                 <div className="grid grid-cols-3 gap-1">
                    <button onClick={() => handleQuickSubmit('Submitted')} className="text-[10px] bg-blue-100 text-blue-700 py-1 rounded hover:bg-blue-200">Submit</button>
                    <button onClick={() => handleQuickSubmit('Rejected')} className="text-[10px] bg-red-100 text-red-700 py-1 rounded hover:bg-red-200">Reject</button>
                    <button onClick={() => handleQuickSubmit('Accepted')} className="text-[10px] bg-emerald-100 text-emerald-700 py-1 rounded hover:bg-emerald-200">Accept</button>
                 </div>
                 <button onClick={() => setShowQuick(false)} className="w-full text-[10px] text-slate-400 mt-1 hover:text-slate-600">Cancel</button>
              </div>
           )}
        </div>
      </div>
    );
  }

  function EditorModal({ paper, onClose, onSave }) {
    // Local state needed for form fields
    const [form, setForm] = useState({
      title: paper.title || '',
      abstract: paper.abstract || '',
      collaborators: (paper.collaborators || []).join(', '),
      tags: (paper.tags || []).join(', '),
      links: paper.links || [],
      submissions: paper.submissions || []
    });

    const handleChange = (f, v) => setForm(prev => ({ ...prev, [f]: v }));
    
    // Submissions Handling
    const addSub = () => setForm(p => ({ ...p, submissions: [...p.submissions, { journal: '', status: 'Submitted', date: todayISO() }] }));
    const updateSub = (i, k, v) => setForm(p => {
       const subs = [...p.submissions]; subs[i][k] = v; return { ...p, submissions: subs };
    });
    const removeSub = (i) => setForm(p => ({ ...p, submissions: p.submissions.filter((_, idx) => idx !== i) }));

    const handleSave = () => {
       onSave({
         ...paper,
         title: form.title,
         abstract: form.abstract,
         collaborators: form.collaborators.split(',').map(s=>s.trim()).filter(Boolean),
         tags: form.tags.split(',').map(s=>s.trim()).filter(Boolean),
         links: form.links.filter(l => l.url),
         submissions: form.submissions.filter(s => s.journal)
       });
    };

    return (
      <Modal title={paper.id ? "Edit Paper" : "Add Paper"} onClose={onClose}>
        <div className="space-y-5">
          {/* Main Info */}
          <div>
            <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Title</label>
            <input value={form.title} onChange={e => handleChange('title', e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Paper Title" />
          </div>
          
          <div className="grid grid-cols-2 gap-4">
             <div>
                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Collaborators</label>
                <input value={form.collaborators} onChange={e => handleChange('collaborators', e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 dark:text-white text-sm" placeholder="Name 1, Name 2" />
             </div>
             <div>
                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Tags</label>
                <input value={form.tags} onChange={e => handleChange('tags', e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 dark:text-white text-sm" placeholder="Econ, Labor, Micro" />
             </div>
          </div>

          <div>
             <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Abstract</label>
             <textarea rows="3" value={form.abstract} onChange={e => handleChange('abstract', e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 dark:text-white text-sm" placeholder="Brief summary..."></textarea>
          </div>

          {/* Submission History Section */}
          <div className="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
             <div className="flex justify-between items-center mb-3">
                <h3 className="text-sm font-bold text-slate-700 dark:text-slate-300">Submission History</h3>
                <button onClick={addSub} className="text-xs bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 px-2 py-1 rounded hover:bg-slate-50">Add</button>
             </div>
             <div className="space-y-2">
                {form.submissions.map((sub, i) => (
                   <div key={i} className="flex gap-2 items-center">
                      <input value={sub.journal} onChange={e => updateSub(i, 'journal', e.target.value)} placeholder="Journal" className="flex-1 text-sm px-2 py-1.5 rounded border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 dark:text-white" />
                      <select value={sub.status} onChange={e => updateSub(i, 'status', e.target.value)} className="text-sm px-2 py-1.5 rounded border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 dark:text-white">
                         {['Submitted', 'Under Revision', 'Accepted', 'Rejected'].map(o => <option key={o}>{o}</option>)}
                      </select>
                      <input type="date" value={sub.date} onChange={e => updateSub(i, 'date', e.target.value)} className="text-sm px-2 py-1.5 rounded border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 dark:text-white w-32" />
                      <button onClick={() => removeSub(i)} className="text-slate-400 hover:text-red-500"><Icons.Trash /></button>
                   </div>
                ))}
                {form.submissions.length === 0 && <p className="text-xs text-slate-400 italic">No submissions tracked yet.</p>}
             </div>
          </div>

          {/* Actions */}
          <div className="pt-4 flex justify-end gap-3 border-t border-slate-100 dark:border-slate-800">
             <button onClick={onClose} className="px-5 py-2 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 font-medium transition">Cancel</button>
             <button onClick={handleSave} className="px-5 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium shadow-md transition">Save Paper</button>
          </div>
        </div>
      </Modal>
    );
  }

  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(<App />);
</script>
</body>
</html>